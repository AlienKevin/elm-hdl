<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
  <link rel="stylesheet" data-name="vs/editor/editor.main" href="../node_modules/monaco-editor/min/vs/editor/editor.main.css">
</head>
<body>

  <main style="display: flex; flex-direction: row; margin: 20px 20px;">
    <div id="editor" style="width: 45vw; height: 90vh; border: grey 1px solid; margin: 0 20px;"></div>
    <div id="rightPanel"></div>
  </main>

  <script>var require = { paths: { 'vs': '../node_modules/monaco-editor/min/vs' } };</script>
  <script src="../node_modules/monaco-editor/min/vs/loader.js"></script>
  <script src="../node_modules/monaco-editor/min/vs/editor/editor.main.nls.js"></script>
  <script src="../node_modules/monaco-editor/min/vs/editor/editor.main.js"></script>
  <script src="public/elm.js"></script>

  <script>

    // Register a new language
    monaco.languages.register({ id: 'hdl', extensions: [ '.hdl' ] });

    // Register a tokens provider for the language
    monaco.languages.setMonarchTokensProvider('hdl', {
      symbols: /[\-\=\.]+/,
      keywords: [
        'let', 'in'
      ],
      operators: [
        '=', '->', '..'
      ],
      digits: /\d+(_+\d+)*/,
      binarydigits: /[0-1]+(_+[0-1]+)*/,
      hexdigits: /[[0-9a-fA-F]+(_+[0-9a-fA-F]+)*/,
      tokenizer: {
        root: [
          { include: 'common' }
        ],
        common: [
          // keyword and identifier
          [/[a-z$][a-zA-Z0-9_$]*/, {
            cases: {
              '@keywords': 'keyword',
              '@default': 'identifier'
            }
          }],

          // number
          [/0[xX](@hexdigits)n?/, 'number.hex'],
          [/0[bB](@binarydigits)n?/, 'number.binary'],
          [/(@digits)n?/, 'number'],

          // whitespace
          { include: '@whitespace' },

          // delimiters and operators
          [/[()\[\]]/, '@brackets'],
          [/!(?=([^=]|$))/, 'delimiter'],
          [/@symbols/, {
            cases: {
              '@operators': 'delimiter',
              '@default': ''
            }
          }],
        ],
        whitespace: [
          [/[ \r\n]+/, ''],
          [/\{\-/, 'comment', '@comment'],
          [/\-\-.*$/, 'comment'],
        ],
        comment: [
          [/[^\{\-]+/, 'comment'],
          [/\-\}/, 'comment', '@pop'],
          [/[\{\-]/, 'comment']
        ],
      }
    });
    monaco.languages.setLanguageConfiguration('hdl', {
      brackets: [
        ['{', '}'],
        ['[', ']'],
        ['(', ')']
      ],
      comments: {
        lineComment: '--',
        blockComment: ['{-', '-}']
      },
      autoClosingPairs: [
        { open: '{', close: '}' },
        { open: '[', close: ']' },
        { open: '(', close: ')' },
      ],
    });

    var editor = monaco.editor.create(document.getElementById("editor"), {
      theme: "vs",
      value: "",
      language: 'hdl'
    });

    var app = Elm.Editor.init({ node: document.getElementById('rightPanel') });

    app.ports.setEditorValue.subscribe(function(newValue) {
      editor.setValue(newValue);
    });

    editor.onDidChangeModelContent((event) => {
      app.ports.editorValueChanged.send(editor.getValue());
    });
  </script>

</body>
</html>