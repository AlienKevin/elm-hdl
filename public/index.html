<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
  <link rel="stylesheet" data-name="vs/editor/editor.main" href="../node_modules/monaco-editor/min/vs/editor/editor.main.css">
</head>
<body>

  <main style="display: flex; flex-direction: row; margin: 20px 20px;">
    <div id="editor" style="width: 45vw; height: 90vh; border: grey 1px solid; margin: 0 20px;"></div>
    <div id="rightPanel"></div>
  </main>

  <script>var require = { paths: { 'vs': '../node_modules/monaco-editor/min/vs' } };</script>
  <script src="../node_modules/monaco-editor/min/vs/loader.js"></script>
  <script src="../node_modules/monaco-editor/min/vs/editor/editor.main.nls.js"></script>
  <script src="../node_modules/monaco-editor/min/vs/editor/editor.main.js"></script>
  <script src="public/elm.js"></script>

  <script>

    // Register a new language
    monaco.languages.register({ id: 'hdl', extensions: [ '.hdl' ] });

    // Register a tokens provider for the language
    monaco.languages.setMonarchTokensProvider('hdl', {
      symbols: /[\-\=\.]+/,
      keywords: [
        'let', 'in'
      ],
      operators: [
        '=', '->', '..'
      ],
      digits: /\d+(_+\d+)*/,
      binarydigits: /[0-1]+(_+[0-1]+)*/,
      hexdigits: /[[0-9a-fA-F]+(_+[0-9a-fA-F]+)*/,
      tokenizer: {
        root: [
          { include: 'common' }
        ],
        common: [
          // keyword and identifier
          [/[a-z$][a-zA-Z0-9_$]*/, {
            cases: {
              '@keywords': 'keyword',
              '@default': 'identifier'
            }
          }],

          // number
          [/0[xX](@hexdigits)n?/, 'number.hex'],
          [/0[bB](@binarydigits)n?/, 'number.binary'],
          [/(@digits)n?/, 'number'],

          // whitespace
          { include: '@whitespace' },

          // delimiters and operators
          [/[()\[\]]/, '@brackets'],
          [/!(?=([^=]|$))/, 'delimiter'],
          [/@symbols/, {
            cases: {
              '@operators': 'delimiter',
              '@default': ''
            }
          }],
        ],
        whitespace: [
          [/[ \r\n]+/, ''],
          [/\{\-/, 'comment', '@comment'],
          [/\-\-.*$/, 'comment'],
        ],
        comment: [
          [/[^\{\-]+/, 'comment'],
          [/\-\}/, 'comment', '@pop'],
          [/[\{\-]/, 'comment']
        ],
      }
    });
    monaco.languages.setLanguageConfiguration('hdl', {
      brackets: [
        ['{', '}'],
        ['[', ']'],
        ['(', ')']
      ],
      comments: {
        lineComment: '--',
        blockComment: ['{-', '-}']
      },
      autoClosingPairs: [
        { open: '{', close: '}' },
        { open: '[', close: ']' },
        { open: '(', close: ')' },
      ],
    });

    var editor = monaco.editor.create(document.getElementById("editor"), {
      theme: "vs",
      value: "",
      language: 'hdl'
    });

    var app = Elm.Editor.init({ node: document.getElementById('rightPanel') });

    app.ports.setEditorValuePort.subscribe(function(newValue) {
      editor.setValue(newValue);
    });

    // type Def =
    // { name : string
    // , params : Param[]
    // , outputs : Param[]
    // , body : string
    // }
    // type Param =
    // { name : string
    // , size : Size
    // }
    // type Size = number | string
    app.ports.generateTruthTablePort.subscribe(function(defs) {
      // declare defs
      defs.forEach(function(def) {
        window[def.name] = new Function(
          def.params.map(function(param) { return param.name; }),
          def.body
        );
      });
      // generate truth table for first def
      var def = defs[1];
      var func = window[def.name];
      var params = def.params;
      var outputs = def.outputs;
      var header = params.map(function(param) { return param.name; }).concat(
        outputs.length === 1
        ? (
          "result"
        )
        : (
          outputs.map(function(output) { return output.name; })
        )
      );
      // full truth table too large
      if (params.some(function(param) { return typeof param.size === "string"; })
        ||params.reduce(function(lengthProduct, currentParam) { return lengthProduct * currentParam.length; }, 1) > 32
      ) {
        var body = generateInputs(params.map(function(param) {
          return { ...param, size : 1 };
        }));
      } else {
        var body = generateInputs(params);
      }
      body = body.map(function(row) {
        var results = func(...row);
        var resultList = [];
        if (outputs.length === 1) {
          resultList = [ results ];
        } else {
          outputs.forEach(function(output) {
            resultList.push(results[output.name]);
          });
        }
        return row.concat(resultList);
      });
      var table = Object.create(null);
      table[def.name] = Object.create(null);
      table[def.name].header = header;
      table[def.name].body = body;
      console.log(table);
      app.ports.receiveTruthTablePort.send(JSON.stringify(table));
    });

    function generateInputs(params) {
      var table = [];
      if (params.length === 1) {
        var upperBound = 2 ** params[0].size;
        for (var i = 0; i < upperBound; i++) {
          table.push([i]);
        }
      } else if (params.length > 1) {
        var headTable = generateInputs(params.slice(0, 1));
        var restsTable = generateInputs(params.slice(1));
        
        headTable.forEach(function(headRow) {
          restsTable.forEach(function(restsRow) {
            var clonedRestsRow = restsRow.slice();
            clonedRestsRow.unshift(headRow[0]);
            table.push(clonedRestsRow);
          });
        });
      }
      return table
    }

    editor.onDidChangeModelContent((event) => {
      app.ports.editorValueChangedPort.send(editor.getValue());
    });
  </script>

</body>
</html>